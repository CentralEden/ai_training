name: ðŸ“š Notebook Tests

# on:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main]
#   schedule:
#     # æ¯Žæ—¥å¤œä¸­ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆUTCã§15:00 = JST 00:00ï¼‰
#     - cron: '0 15 * * *'

jobs:
  test-notebooks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
        
    steps:
    - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ðŸ“¦ Poetryã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: false
        virtualenvs-in-project: false
        
    - name: ðŸ“¦ Poetryã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v3
      with:
        path: ~/.cache/pypoetry
        key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          poetry-${{ runner.os }}-
          
    - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        poetry install --with dev --no-interaction --no-root
        # PyTorchã‚’å€‹åˆ¥ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        poetry run pip install torch==2.0.1+cpu torchvision==0.15.2+cpu -f https://download.pytorch.org/whl/torch_stable.html
        
    - name: ðŸ§ª Notebookãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        # å…¨ã¦ã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆ
        poetry run pytest --nbval-lax --tb=short \
          foundations/**/*.ipynb \
          specializations/**/*.ipynb \
          advanced/**/*.ipynb \
          || true  # ä¸€æ™‚çš„ã«ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’è¨±å¯
          
    - name: ðŸ“Š ãƒ†ã‚¹ãƒˆçµæžœãƒ¬ãƒãƒ¼ãƒˆ
      if: always()
      run: |
        echo "## ðŸ“š Notebook Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Python version: ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Test date: $(date)" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ” ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      run: |
        find . -name "*.ipynb" -not -path "./.git/*" | \
        xargs -I {} python -m jupyter nbconvert --to script --stdout {} > /dev/null || true
        
  lint-notebooks:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ“¦ Poetryã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: false
        virtualenvs-in-project: false
        
    - name: ðŸ“¦ Poetryã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v3
      with:
        path: ~/.cache/pypoetry
        key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          poetry-${{ runner.os }}-
          
    - name: ðŸ“¦ Lintãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        poetry install --with dev --no-interaction --no-root
        
    - name: ðŸŽ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆç¢ºèª
      run: |
        poetry run nbqa black . --check --diff || true
        poetry run nbqa isort . --check --diff || true
        
    - name: ðŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        poetry run nbqa flake8 . --extend-ignore=E203,W503 --max-line-length=88 || true
        
  check-links:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ðŸ”— ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
      uses: lycheeverse/lychee-action@v1.8.0
      with:
        args: --verbose --no-progress '**/*.md' '**/*.ipynb'
        fail: false  # ãƒªãƒ³ã‚¯åˆ‡ã‚Œã§CIã‚’å¤±æ•—ã•ã›ãªã„
        
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ðŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan.sarif'
      continue-on-error: true
      
    - name: ðŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ
      run: |
        echo "## ðŸ›¡ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY 